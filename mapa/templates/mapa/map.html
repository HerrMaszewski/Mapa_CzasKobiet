{% extends "base.html" %}
{% load static %}

{% block right_sidebar %}
  <div id="sidebarResults" class="sidebar-right">
    <div id="results-count"></div>
    <div id="results-loader"><div class="loader"></div></div>
    <div id="results-list"></div>
  </div>
{% endblock %}

{% block map %}
  <div id="map"></div>
  <button class="toggle-results-btn" onclick="toggleResults()">ğŸ“‹ Wyniki</button>
{% endblock %}

{% block left_sidebar %}

<div id="filters-panel">
    <h3>ZnajdÅº pomoc w swojej okolicy</h3>

    <div class="location-wrapper">
      <div class="location-row">
          <div class="input-row">
            <div class="location-col">
              <label for="address-input">Podaj miejscowoÅ›Ä‡:</label>
              <input type="text" id="address-input" placeholder="np. PoznaÅ„"/>
            </div>

            <div class="radius-col">
              <label for="radius-select">PromieÅ„:</label>
              <select id="radius-select">
                  <option value="10">10 km</option>
                  <option value="25">25 km</option>
                  <option value="50" selected>50 km</option>
                  <option value="100">100 km</option>
                  <option value="150">150 km</option>
                  <option value="200">200 km</option>
                  <option value="500">500 km</option>
              </select>
            </div>
        </div>
    </div>

      <div id="address-error" class="error-msg"></div>
    </div>

    <h4>Rodzaj pomocy:</h4>
    <div class="filters-grid" id="help-filters">
      <div class="filter-tile help-filter" data-filter="psychological_help">
        <div class="icon">ğŸ§ </div>
        <div class="label">Psychologiczna</div>
      </div>
      <div class="filter-tile help-filter" data-filter="legal_help">
        <div class="icon">âš–ï¸</div>
        <div class="label">Prawna</div>
      </div>
      <div class="filter-tile help-filter" data-filter="social_help">
        <div class="icon">ğŸ </div>
        <div class="label">Socjalna</div>
      </div>
      <div class="filter-tile help-filter" data-filter="accommodation">
        <div class="icon">ğŸ›ï¸</div>
        <div class="label">Nocleg</div>
      </div>
    </div>
    <div id="help-error" class="error-msg"></div>

    <h4>Rodzaj instytucji:</h4>
        <div class="type-filters-grid" id="type-filters">
          <div class="filter-tile type-filter" data-type="NGO">PozarzÄ…dowe</div>
          <div class="filter-tile type-filter" data-type="GOV">Publiczne</div>
        </div>
        <div id="type-error" class="error-msg"></div>

    <hr>

      <button id="search-btn" class="main-search-btn">ğŸ” Szukaj</button>

    <div class="button-row small-controls">
        <button id="geolocate-btn">ğŸ“ Lokalizuj</button>
        <button id="reset-btn">ğŸ—‘ï¸ Resetuj</button>
    </div>

</div>

{% endblock %}

{% block scripts %}
<script id="institution-data" type="application/json">
    {{ institutions_json|safe }}
</script>

<script>
    let currentPage = 1;
    let lastCenter = null;
    let lastRadius = null;
</script>



<!-- Leaflet i dodatki -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<script>
document.addEventListener('DOMContentLoaded', function () {
    console.log("âœ… DOM zaÅ‚adowany");
    const initialCenter = [52.0, 19.0];
    const initialZoom = window.innerWidth <= 768 ? 3 : 6;

    const map = L.map('map', {
        center: initialCenter,
        zoom: initialZoom,
        minZoom: 6,
        maxZoom: 16,
        maxBounds: [[48.8, 13.5], [55.0, 24.5]]
    });


    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 19
    }).addTo(map);

    window.addEventListener('resize', () => {
        setTimeout(() => map.invalidateSize(), 200);
    });

    const institutions = JSON.parse(document.getElementById('institution-data').textContent);
    const markerCluster = L.markerClusterGroup();
    let currentCircle = null;
    let userMarker = null;

    function toggleResults() {
      const sidebar = document.getElementById('sidebarResults');
      sidebar.classList.toggle('visible');

      // JeÅ›li sidebar jest ukryty, zresetuj tekst przycisku
      const btn = document.querySelector('.toggle-results-btn');
      if (btn) {
        const isVisible = sidebar.classList.contains('visible');
        btn.textContent = isVisible ? 'âŒ Zamknij wyniki' : 'ğŸ“‹ Wyniki';
      }

      setTimeout(() => map.invalidateSize(), 300);
    }

    window.toggleResults = toggleResults;

    function showError(id, msg) {
        const el = document.getElementById(id);
        el.textContent = msg;
        el.classList.remove('visible');
        void el.offsetWidth;
        el.classList.add('visible');
        setTimeout(() => {
            el.classList.remove('visible');
            el.textContent = '';
        }, 4000);
    }

    function getActiveTypes() {
        return Array.from(document.querySelectorAll('#type-filters .filter-tile.active'))
            .map(tile => tile.dataset.type);
    }

    function getActiveFilters() {
        return Array.from(document.querySelectorAll('#help-filters .filter-tile.active'))
            .map(tile => tile.dataset.filter)
            .filter(Boolean);
    }

    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
        return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
    }

    document.querySelectorAll('.filter-tile').forEach(tile => {
        tile.addEventListener('click', () => tile.classList.toggle('active'));
    });

    document.getElementById('geolocate-btn').addEventListener('click', () => {
        if (!navigator.geolocation) {
            showError('address-error', 'Twoja przeglÄ…darka nie obsÅ‚uguje geolokalizacji.');
            return;
        }

        const radius = parseFloat(document.getElementById('radius-select').value) || 50;
        const types = getActiveTypes();
        const filters = getActiveFilters();

        if (types.length === 0) {
            showError('type-error', 'Wybierz rodzaj instytucji (PozarzÄ…dowa lub Publiczna).');
            return;
        }

        if (filters.length === 0) {
            showError('help-error', 'Wybierz co najmniej jeden rodzaj pomocy.');
            return;
        }

        navigator.geolocation.getCurrentPosition((position) => {
            const loc = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };

            map.setView(loc, 12);
            renderInstitutions(loc, radius, true);
            const sidebar = document.getElementById('sidebarResults');
            sidebar.classList.add('visible');;

            // â›” Tymczasowo wyÅ‚Ä…czone rysowanie okrÄ™gu â€“ do ewentualnej poprawy w przyszÅ‚oÅ›ci (problemy z rozjeÅ¼dÅ¼aniem mapy)

            // if (currentCircle) map.removeLayer(currentCircle);
            // const markerRadiusPx = Math.min(radius * 2, 100); // np. 50km â†’ 100px marker
            // currentCircle = L.circleMarker(loc, {
            //     radius: markerRadiusPx,
            //     color: 'purple',
            //     fillColor: 'purple',
            //     fillOpacity: 0.15,
            //     weight: 2
            // }).addTo(map);
            // currentCircle._path?.classList.add('search-radius-circle');
        }, () => {
            showError('address-error', 'Nie udaÅ‚o siÄ™ pobraÄ‡ lokalizacji.');
        });
    });

    document.getElementById('reset-btn').addEventListener('click', () => {
    document.getElementById('address-input').value = '';
    document.querySelectorAll('.filter-tile').forEach(tile => tile.classList.add('active'));

    if (currentCircle) { map.removeLayer(currentCircle); currentCircle = null; }
    if (userMarker) { map.removeLayer(userMarker); userMarker = null; }

    document.getElementById('results-list').innerHTML = '';
    document.getElementById('results-count').textContent = '';
    document.getElementById('results-loader').classList.remove('visible');

    renderInstitutions(null, null, false); // Tylko markery
    map.setView(initialCenter, initialZoom);

    document.getElementById('sidebarResults')?.classList.remove('visible');
    const btn = document.querySelector('.toggle-results-btn');
    if (btn) btn.textContent = 'ğŸ“‹ Wyniki';
});

    document.getElementById('search-btn').addEventListener('click', () => {
    const address = document.getElementById('address-input').value.trim();
    const radius = parseFloat(document.getElementById('radius-select').value) || 50;
    const types = getActiveTypes();
    const filters = getActiveFilters();

    if (!address) {
        showError('address-error', 'Wpisz nazwÄ™ miejscowoÅ›ci.');
        return;
    }

    if (types.length === 0) {
        showError('type-error', 'Wybierz rodzaj instytucji (GOV lub NGO).');
        return;
    }

    if (filters.length === 0) {
        showError('help-error', 'Wybierz co najmniej jeden rodzaj pomocy.');
        return;
    }

    const geocoder = L.Control.Geocoder.nominatim();
    geocoder.geocode(`${address}, Polska`, function (results) {
        if (!results || results.length === 0) {
            showError('address-error', 'Nie znaleziono miejscowoÅ›ci.');
            return;
        }

        const cityResult = results.find(r =>
        ['city', 'town', 'village', 'hamlet', 'municipality', 'locality', 'administrative', 'neighbourhood']
        .includes(r.properties?.type)
        );

        if (!cityResult) {
            showError('address-error', 'Nie znaleziono miejscowoÅ›ci w Polsce.');
            return;
        }

        const loc = cityResult.center;
        const lat = loc.lat;
        const lng = loc.lng;

        const isInPoland = lat >= 48.8 && lat <= 55.0 && lng >= 13.5 && lng <= 24.5;
        if (!isInPoland) {
            showError('address-error', 'Podana miejscowoÅ›Ä‡ nie znajduje siÄ™ w Polsce.');
            return;
        }

        // âœ… JeÅ›li przeszÅ‚o wszystkie warunki:
        map.setView(loc, 12);
        renderInstitutions(loc, radius, true);

    //    if (currentCircle) map.removeLayer(currentCircle);
    //    currentCircle = L.circleMarker(loc, {
    //        radius: Math.min(radius * 2, 100),
    //        color: 'purple',
    //        fillColor: 'purple',
    //        fillOpacity: 0.15,
    //        weight: 2
    //    }).addTo(map);
    //    currentCircle._path?.classList.add('search-radius-circle');

    //    if (userMarker) map.removeLayer(userMarker);
    //    userMarker = L.marker(loc).addTo(map);
    });
});

    document.addEventListener('click', (e) => {
        if (!suggestionBox.contains(e.target) && e.target !== addressInput) {
            suggestionBox.classList.add('hidden');
        }
    });

    function renderInstitutions(center = null, radius = null, renderList = false) {
    markerCluster.clearLayers();

    const resultsContainer = document.getElementById('results-list');
    const resultsCount = document.getElementById('results-count');
    const loader = document.getElementById('results-loader');

    if (renderList) {
        resultsContainer.innerHTML = '';
        resultsCount.textContent = '';
        loader.classList.add('visible');
        lastCenter = center;
        lastRadius = radius;
    }

    const filters = getActiveFilters();
    const types = getActiveTypes();
    const results = [];

    institutions.forEach(inst => {
        const lat = inst.location.latitude;
        const lng = inst.location.longitude;
        const distance = center ? getDistance(center.lat, center.lng, lat, lng) : null;

        const matchesFilter = filters.length === 0 || filters.every(type => inst[type]);
        const inRadius = !radius || (distance !== null && distance <= radius);
        const matchesType = types.length === 0 || types.includes(inst.type);
        const shouldDisplay = (!center && !radius) || (matchesFilter && matchesType && inRadius);

        if (shouldDisplay) {
            const icons = [];
            if (inst.psychological_help) icons.push('ğŸ§ ');
            if (inst.legal_help) icons.push('âš–ï¸');
            if (inst.social_help) icons.push('ğŸ ');
            if (inst.accommodation) icons.push('ğŸ›ï¸');

            const typeBadge = `<div class="type-badge ${inst.type === 'GOV' ? 'public' : 'ngo'}">
            ${inst.type === 'GOV' ? 'Publiczna' : 'PozarzÄ…dowa'}
            </div>`;

            const popup = `
                <strong>${inst.name}</strong><br>
                ${typeBadge}<br>
                ${inst.address}<br>
                ğŸ“ ${inst.phone_number}<br>
                ğŸ“§ ${inst.email || 'brak'}<br>
                ğŸ“ Infolinia: ${inst.infoline || 'brak'}<br>
                ğŸ•’ ${inst.opening_hours || ''}<br>
                ${icons.join(' ')}
            `;

            const iconUrl = inst.name.includes("Czas Kobiet")
            ? 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-violet.png'
            : inst.type === 'GOV'
              ? 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png'
              : 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png';

            const icon = new L.Icon({
              iconUrl,
              shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });
            const marker = L.marker([lat, lng], { icon }).bindPopup(popup);
            markerCluster.addLayer(marker);

            results.push({ inst, distance, lat, lng, icons, typeBadge, marker });
        }
    });

    map.addLayer(markerCluster);

    if (center && radius) {
        const bounds = L.latLng(center.lat, center.lng).toBounds(radius * 2000);
        map.fitBounds(bounds, { maxZoom: 12 });
    }

    if (renderList) {
        setTimeout(() => {
            loader.classList.remove('visible');

            if (results.length === 0) {
                document.getElementById('results-list').innerHTML = '';
                document.getElementById('results-count').textContent = '';
                document.getElementById('sidebarResults').classList.remove('visible');
                showError('address-error', 'Brak wynikÃ³w dla podanych kryteriÃ³w.');
                return;
            }

            const priorityNames = ['Fundacja Czas Kobiet', 'Feminoteka'];

            results.sort((a, b) => {
                const isPriority = name => priorityNames.some(p => name.toLowerCase().includes(p.toLowerCase()));
                const aIsPriority = isPriority(a.inst.name);
                const bIsPriority = isPriority(b.inst.name);

                if (aIsPriority && !bIsPriority) return -1;
                if (!aIsPriority && bIsPriority) return 1;
                return a.distance - b.distance;
            });

            const resultsPerPage = 5;
            const totalPages = Math.ceil(results.length / resultsPerPage);
            const startIndex = (currentPage - 1) * resultsPerPage;
            const endIndex = startIndex + resultsPerPage;
            const pageResults = results.slice(startIndex, endIndex);

            // Wstawianie informacji na gÃ³rÄ™ sidebaru
            resultsCount.innerHTML = `
                <div class="results-summary">
                    ${results.length > 0
                        ? center && radius
                            ? `Znaleziono ${results.length} miejsc oferujÄ…cych wybrane formy pomocy w promieniu ${radius} km`
                            : `Znaleziono ${results.length} miejsc oferujÄ…cych wybrane formy pomocy`
                        : `Brak wynikÃ³w`}
                </div>
            `;

            // CzyÅ›Ä‡ kontener na karty
            resultsContainer.innerHTML = '';

            pageResults.forEach(({ inst, distance, lat, lng, icons, typeBadge, marker }) => {
                const div = document.createElement('div');
                div.className = `result-card ${inst.type === 'GOV' ? 'gov-card' : 'ngo-card'}`;
                div.innerHTML = `
                    <div class="result-header">
                        <div class="type-badge ${inst.type === 'GOV' ? 'public' : 'ngo'}">
                            ${inst.type === 'GOV' ? 'Publiczna' : 'PozarzÄ…dowa'}
                        </div>
                        <div class="result-title">${inst.name}</div>
                    </div>
                    <div class="distance-info">ğŸ“ ${distance !== null ? `${distance.toFixed(1)} km` : ''}</div>
                    <div class="result-body collapsed">
                        <div class="result-content">
                            <p>${inst.address}</p>
                            <p>ğŸ“ ${inst.phone_number || 'brak'}</p>
                            <p>ğŸ“ Infolinia: ${inst.infoline || 'brak'}</p>
                            <p>ğŸ“§ ${inst.email || 'brak'}</p>
                            <p>ğŸ•’ ${inst.opening_hours || 'brak'}</p>
                            <div class="help-icons">${icons.join(' ')}</div>
                        </div>
                    </div>
                    <div class="result-footer">
                        <button class="toggle-btn">PokaÅ¼ wiÄ™cej</button>
                    </div>
                `;

                const btn = div.querySelector('.toggle-btn');
                const body = div.querySelector('.result-body');
                let expanded = false;
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    expanded = !expanded;
                    body.classList.toggle('expanded', expanded);
                    btn.textContent = expanded ? 'PokaÅ¼ mniej' : 'PokaÅ¼ wiÄ™cej';
                });

                div.addEventListener('click', () => {
                    map.flyTo([lat, lng], 16, { animate: true, duration: 0.6 });
                    setTimeout(() => marker.openPopup(), 600);
                });

                resultsContainer.appendChild(div);
            });

            const pagination = document.createElement('div');
            pagination.className = 'pagination';

            if (currentPage > 1) {
                const prevBtn = document.createElement('button');
                prevBtn.className = 'page-arrow';
                prevBtn.innerHTML = 'â†';
                prevBtn.addEventListener('click', () => renderPage(currentPage - 1));
                pagination.appendChild(prevBtn);
            }

            for (let i = 1; i <= totalPages; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = 'page-num';
                if (i === currentPage) pageBtn.classList.add('active');
                pageBtn.innerText = i;
                pageBtn.addEventListener('click', () => renderPage(i));
                pagination.appendChild(pageBtn);
            }

            if (currentPage < totalPages) {
                const nextBtn = document.createElement('button');
                nextBtn.className = 'page-arrow';
                nextBtn.innerHTML = 'â†’';
                nextBtn.addEventListener('click', () => renderPage(currentPage + 1));
                pagination.appendChild(nextBtn);
            }

            resultsContainer.appendChild(pagination);
        }, 300);
    }
}

function renderPage(page) {
    currentPage = page;
    renderInstitutions(lastCenter, lastRadius, true);
}

// render po zaÅ‚adowaniu
renderInstitutions(null, null, false);
});

</script>

{% endblock %}