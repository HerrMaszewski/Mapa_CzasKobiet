{% extends "base.html" %}
{% load static %}

{% block right_sidebar %}
  <div id="sidebarResults" class="sidebar-right">
    <div id="results-count"></div>
    <div id="results-loader"><div class="loader"></div></div>
    <div id="results-list"></div>
  </div>
{% endblock %}

{% block map %}
  <div id="map"></div>
{% endblock %}

{% block left_sidebar %}
<div class="sidebar-logo">
  <a href="https://www.czaskobiet.org" target="_blank" rel="noopener">
    <img src="{% static 'images/logo bez tÅ‚a.png' %}" alt="Czas Kobiet">
  </a>
</div>

<div id="filters-panel">
  <h3>ZnajdÅº pomoc w swojej okolicy</h3>

  <div class="location-wrapper">
    <div class="location-row">
      <div class="input-row">
        <div class="location-col">
          <label for="address-input">MiejscowoÅ›Ä‡</label>
          <input type="text" id="address-input" placeholder="np. PoznaÅ„"/>
        </div>

        <div class="radius-col">
          <label for="radius-select">PromieÅ„</label>
          <select id="radius-select">
            <option value="10">10 km</option>
            <option value="15">15 km</option>
            <option value="30">30 km</option>
            <option value="50" selected>50 km</option>
            <option value="100">100 km</option>
            <option value="150">150 km</option>
            <option value="200">200 km</option>
            <option value="500">500 km</option>
          </select>
        </div>
      </div>
    </div>
    <div id="address-error" class="error-msg"></div>
  </div>

  <h4>Wybierz rodzaj pomocy</h4>
    <div class="filters-grid" id="help-filters">
      <div class="filter-tile help-filter" data-filter="psychological_help">
        <span class="icon"><img src="{% static 'icons/psychologiczna.svg' %}" alt="" /></span>
        <span class="label">Psychologiczna</span>
      </div>
      <div class="filter-tile help-filter" data-filter="legal_help">
        <span class="icon"><img src="{% static 'icons/prawna.svg' %}" alt="" /></span>
        <span class="label">Prawna</span>
      </div>
      <div class="filter-tile help-filter" data-filter="social_help">
        <span class="icon"><img src="{% static 'icons/socjalna.svg' %}" alt="" /></span>
        <span class="label">Socjalna</span>
      </div>
      <div class="filter-tile help-filter" data-filter="accommodation">
        <span class="icon"><img src="{% static 'icons/nocleg.svg' %}" alt="" /></span>
        <span class="label">Nocleg</span>
      </div>
    </div>
  <div id="help-error" class="error-msg"></div>

  <h4>Wybierz rodzaj oÅ›rodka pomocowego</h4>
  <div class="type-filters-grid" id="type-filters">
    <div class="filter-tile type-filter" data-type="NGO">PozarzÄ…dowe</div>
    <div class="filter-tile type-filter" data-type="GOV">Publiczne</div>
  </div>
  <div id="type-error" class="error-msg"></div>

  <hr>

  <button id="search-btn" class="main-search-btn">Szukaj</button>

  <div class="button-row small-controls">
    <button id="geolocate-btn">Lokalizuj</button>
    <button id="reset-btn">Resetuj</button>
  </div>
</div>

<a href="{% url 'about' %}" class="info-btn">O nas</a>
{% endblock %}

{% block scripts %}
<script id="institution-data" type="application/json">
  {{ institutions_json|safe }}
</script>

<!-- Leaflet i dodatki -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<script>
document.addEventListener('DOMContentLoaded', function () {
  // ===== KONFIG =====
  const POLAND_BOUNDS = L.latLngBounds([48.8, 13.5], [55.0, 24.5]);
  const MAX_BOUNDS    = POLAND_BOUNDS.pad(0.02);
  const START_CENTER  = [52.0, 19.0];
  const START_ZOOM    = 7;

  // StaÅ‚e przesuniÄ™cie tylko dla fitToPoland (start/reset)
  // +X => treÅ›Ä‡ mapy idzie w lewo (viewport w prawo), +Y => trochÄ™ w dÃ³Å‚
  const EXTRA_PAN_X = 0;   // dostosuj jeÅ›li chcesz bardziej w lewo
  const EXTRA_PAN_Y = 0;    // w dÃ³Å‚, Å¼eby byÅ‚o widaÄ‡ zoom +/-

  // Czy przesuwaÄ‡ mapÄ™ przy otwieraniu/zwijaniu wynikÃ³w? (NIE)
  const MOVE_ON_RESULTS = false;

  // ===== MAPA =====
  const map = L.map('map', {
    preferCanvas: true,
    minZoom: 7,
    maxZoom: 16,
    maxBounds: MAX_BOUNDS,
    maxBoundsViscosity: 1.0,
    zoomControl: true
  });

  const isMobile = window.matchMedia('(max-width: 768px)').matches;

    // JeÅ›li chcesz jednoczeÅ›nie ustawiÄ‡ inne centrum i zoom:
    if (isMobile) {
    map.setView([52.0, 19.0], 2);   // Å›rodek PL + oddalenie; dopasuj wg potrzeb
    }

  const SMALL_ICONS = {
  GOV: {
    psychological_help: "{% static 'icons/psychologiczna-glyph.svg' %}",
    legal_help:         "{% static 'icons/prawna-magenta-glyph.svg' %}",
    social_help:        "{% static 'icons/socjalna-manta-glyph.svg' %}",
    accommodation:      "{% static 'icons/nocleg-glyph.svg' %}",
  },
  NGO: {
    psychological_help: "{% static 'icons/psychologiczna-glyph_pink.svg' %}",
    legal_help:         "{% static 'icons/prawna-glyph_pink.svg' %}",
    social_help:        "{% static 'icons/socjalna_glyph_pink.svg' %}",
    accommodation:      "{% static 'icons/nocleg-glyph_pink.svg' %}",
  }
};

  const CONTACT_ICONS = {
  GOV: {
    phone:   "{% static 'icons/phone_mag.svg' %}",
    email:   "{% static 'icons/email_mag.svg' %}",
    infoline:"{% static 'icons/info_mag.svg' %}",
    hours:   "{% static 'icons/clock_mag.svg' %}",
  },
  NGO: {
    phone:   "{% static 'icons/phone_pink.svg' %}",
    email:   "{% static 'icons/email_pink.svg' %}",
    infoline:"{% static 'icons/info_pink.svg' %}",
    hours:   "{% static 'icons/clock_pink.svg' %}",
  }
};

  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap, &copy; CARTO',
    detectRetina: true
  }).addTo(map);

  // Start PL (zaraz i tak zrobimy fitToPoland)
  map.setView(START_CENTER, START_ZOOM, { animate: false });

  // ===== UTYL =====
  const $  = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));

  function dims () {
    const headerH = $('.header')?.offsetHeight || 0;
    const footerH = $('footer')?.offsetHeight || 0;
    const leftW   = $('.sidebar-left')?.offsetWidth || 0;

    // PRAWDZIWY prawy margines â€“ padding-right na .layout-container (TwÃ³j â€žpasekâ€)
    const layout      = $('.layout-container');
    const rightGutter = layout ? (parseInt(getComputedStyle(layout).paddingRight) || 0) : 0;

    // odstÄ™p miÄ™dzy kolumnami (sidebar + mapa)
    const main    = $('.main-content');
    const gridGap = main ? (parseInt(getComputedStyle(main).columnGap) || 0) : 0;

    return { headerH, footerH, leftW, rightGutter, gridGap };
  }

  // Dopasowanie Polski + â€žoptyczneâ€ przesuniÄ™cie (tylko tu!)
  function fitToPoland () {
    const { headerH, footerH, leftW, rightGutter, gridGap } = dims();

    map.fitBounds(POLAND_BOUNDS, {
      paddingTopLeft:     [leftW + gridGap + 8, headerH + 8],
      paddingBottomRight: [rightGutter + 8,     footerH + 8],
      maxZoom: 7,
      animate: false
    });

    // Po dopasowaniu â€” aktualizuj rozmiar i przesuÅ„ delikatnie
    requestAnimationFrame(() => {
      map.invalidateSize(false);
      visualNudge();
    });
  }

  // StaÅ‚e, niewielkie przesuniÄ™cie Å›rodka (tylko po fitToPoland)
  function visualNudge () {
    const { headerH, leftW, rightGutter } = dims();

    // WyrÃ³wnanie rÃ³Å¼nicy szerokoÅ›ci: lewy panel vs prawy â€žoddechâ€
    const dxBase = (leftW - rightGutter) / 2;

    // KoÅ„cowe przesuniÄ™cie
    const dx = dxBase + EXTRA_PAN_X;
    const dy = (headerH / 2) + EXTRA_PAN_Y;

    map.panBy([dx, dy], { animate: false });
  }

  // Kadrowanie obszaru wyszukiwania (BEZ visualNudge!)
  function focusSearchArea(center, radiusKm) {
    const bounds = L.latLng(center.lat, center.lng).toBounds(radiusKm * 2000); // 2*R
    map.fitBounds(bounds, { maxZoom: 12, animate: false });
    requestAnimationFrame(() => map.invalidateSize(false));
  }

  // Debounce
  function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

  // ===== PANEL WYNIKÃ“W / PRZYCISK =====
  function updateToggleButtons(isVisible) {
    $$('.toggle-results-btn').forEach(btn => {
      btn.textContent = isVisible ? 'âŒ Zamknij wyniki' : 'ðŸ“‹ Wyniki';
    });
  }
  function showSidebar() {
    $('#sidebarResults')?.classList.add('visible');
    document.body.classList.add('results-open');
    updateToggleButtons(true);
    if (MOVE_ON_RESULTS) setTimeout(fitToPoland, 60);
  }
  function hideSidebar() {
    $('#sidebarResults')?.classList.remove('visible');
    document.body.classList.remove('results-open');
    updateToggleButtons(false);
    if (MOVE_ON_RESULTS) setTimeout(fitToPoland, 60);
  }
  window.toggleResults = function () {
    const sidebar = $('#sidebarResults');
    const isVisible = sidebar?.classList.toggle('visible');
    document.body.classList.toggle('results-open', !!isVisible);
    updateToggleButtons(!!isVisible);
    if (MOVE_ON_RESULTS) setTimeout(fitToPoland, 60);
  };

    function normalizeTimeRange(str) {
      if (!str) return '';
      // usuÅ„ spacje wokÃ³Å‚ myÅ›lnika i zamieÅ„ '-' lub 'â€“' na pÃ³Å‚pauzÄ™
      str = str.replace(/\s*[-â€“]\s*/g, 'â€“');

      // poprawnie dodaj wiodÄ…ce zero tylko do godzin jednocyfrowych
      str = str.replace(/\b(\d{1,2})(?::(\d{2}))?\b/g, (match, h, m) => {
        h = h.padStart(2, '0');        // godzina 1 -> 01
        if (m) return `${h}:${m}`;     // jeÅ›li minuty sÄ…, zostaw jak sÄ…
        return h;                      // jeÅ›li brak minut, tylko godzina
      });

      return str;
    }
  // ===== DANE / KLASTRY =====
  const institutions  = JSON.parse(document.getElementById('institution-data').textContent);
    const markerCluster = L.markerClusterGroup({
      maxClusterRadius: 120,
      iconCreateFunction: function(cluster) {
        const count = cluster.getChildCount();

        // kolor wg licznoÅ›ci (dostosuj do brandu/mapy)
        let color = '#5f2b75'; // fiolet bazowy
        //if (count < 20) color = '#da8ff8';    // jasnozielony
        //else if (count < 50) color = '#923cb1';
        //else if (count < 100) color = '#5f2b75';
        //else color = '#2f1144';               // ciemnozielony

        return new L.DivIcon({
          html: `<div style="
            background:${color};
            border-radius:50%;
            color:#fff;
            width:40px;height:40px;
            display:flex;align-items:center;justify-content:center;
            font-weight:bold;">${count}</div>`,
          className: 'custom-cluster',
          iconSize: [40, 40]
        });
      }
    }).addTo(map);

  // ===== STATE =====
  let currentPage  = 1;
  let lastCenter   = null;
  let lastRadius   = null;
  let userMarker   = null;
  const RESULTS_PER_PAGE = 5;

  // ===== UTIL =====
  function showError(id, msg) {
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = msg;
    el.classList.remove('visible');
    void el.offsetWidth;
    el.classList.add('visible');
    setTimeout(() => { el.classList.remove('visible'); el.textContent = ''; }, 4000);
  }
  function getActiveTypes() {
    return Array.from(document.querySelectorAll('#type-filters .filter-tile.active'))
      .map(tile => tile.dataset.type);
  }
  function getActiveFilters() {
    return Array.from(document.querySelectorAll('#help-filters .filter-tile.active'))
      .map(tile => tile.dataset.filter)
      .filter(Boolean);
  }
  function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2)**2 +
      Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
      Math.sin(dLon/2)**2;
    return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
  }

  // KlikalnoÅ›Ä‡ kafelkÃ³w
  $$('.filter-tile').forEach(tile =>
    tile.addEventListener('click', () => tile.classList.toggle('active'))
  );

  // ===== GEO =====
  document.getElementById('geolocate-btn')?.addEventListener('click', () => {
    if (!navigator.geolocation) return showError('address-error', 'Twoja przeglÄ…darka nie obsÅ‚uguje geolokalizacji.');

    const radius  = parseFloat(document.getElementById('radius-select').value) || 50;
    const types   = getActiveTypes();
    const filters = getActiveFilters();

    if (!types.length)   return showError('type-error', 'Wybierz rodzaj instytucji (PozarzÄ…dowa lub Publiczna).');
    if (!filters.length) return showError('help-error', 'Wybierz co najmniej jeden rodzaj pomocy.');

    navigator.geolocation.getCurrentPosition((pos) => {
      const loc = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      map.setView(loc, 12);
      renderInstitutions(loc, radius, true);
      showSidebar();
      focusSearchArea(loc, radius); // <- bez visualNudge
    }, () => showError('address-error', 'Nie udaÅ‚o siÄ™ pobraÄ‡ lokalizacji.'));
  });

  // ===== RESET =====
  document.getElementById('reset-btn')?.addEventListener('click', () => {
    document.getElementById('address-input').value = '';
    document.querySelectorAll('.filter-tile').forEach(t => t.classList.remove('active'));

    if (userMarker) { map.removeLayer(userMarker); userMarker = null; }

    document.getElementById('results-list').innerHTML = '';
    document.getElementById('results-count').textContent = '';
    document.getElementById('results-loader').classList.remove('visible');

    renderInstitutions(null, null, false);
    hideSidebar();
    fitToPoland(); // <- tutaj jest visualNudge
  });

  // ===== SZUKAJ =====
  document.getElementById('search-btn')?.addEventListener('click', () => {
    const address = document.getElementById('address-input').value.trim();
    const radius  = parseFloat(document.getElementById('radius-select').value) || 50;
    const types   = getActiveTypes();
    const filters = getActiveFilters();

    if (!address)        return showError('address-error', 'Wpisz nazwÄ™ miejscowoÅ›ci.');
    if (!types.length)   return showError('type-error', 'Wybierz rodzaj instytucji (GOV lub NGO).');
    if (!filters.length) return showError('help-error', 'Wybierz co najmniej jeden rodzaj pomocy.');

    const geocoder = L.Control.Geocoder.nominatim();
    geocoder.geocode(address + ', Polska', function (results) {
      if (!results || !results.length) return showError('address-error', 'Nie znaleziono miejscowoÅ›ci.');
      const cityResult = results.find(r =>
        ['city','town','village','hamlet','municipality','locality','administrative','neighbourhood']
          .includes(r.properties?.type)
      );
      if (!cityResult) return showError('address-error', 'Nie znaleziono miejscowoÅ›ci w Polsce.');
      const { lat, lng } = cityResult.center;
      if (!(lat >= 48.8 && lat <= 55.0 && lng >= 13.5 && lng <= 24.5))
        return showError('address-error', 'Podana miejscowoÅ›Ä‡ nie znajduje siÄ™ w Polsce.');

      const loc = { lat, lng };
      map.setView([lat, lng], 12);
      renderInstitutions(loc, radius, true);
      showSidebar();
      focusSearchArea(loc, radius); // <- bez visualNudge
    });
  });

  // ===== MARKERY SVG â€“ KOLORY BRANDU =====
  const PIN_COLORS = {
    NGO: '#e5007e',     // magenta (PozarzÄ…dowe)
    GOV: '#35173f',     // gÅ‚Ä™boki fiolet (Publiczne)
    PRIORITY: '#7b2cbf' // np. Czas Kobiet â€“ opcjonalnie
  };

  function pinSVG(color) {
    return `
    <svg width="30" height="44" viewBox="0 0 30 44" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <defs>
        <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
          <feDropShadow dx="0" dy="2" stdDeviation="2" flood-opacity=".35"/>
        </filter>
      </defs>
      <path filter="url(#shadow)"
        d="M15 0C7.27 0 1 6.27 1 14c0 9.24 12.2 21.96 13.0 22.82a1.5 1.5 0 0 0 2.0 0C16.8 35.96 29 23.24 29 14 29 6.27 22.73 0 15 0z"
        fill="${color}" stroke="white" stroke-width="2"/>
      <circle cx="15" cy="14" r="5.5" fill="white" fill-opacity=".9"/>
    </svg>`;
  }

  // ===== RENDER INSTYTUCJI =====
  function renderInstitutions(center = null, radius = null, renderList = false) {
    markerCluster.clearLayers();

    const resultsContainer = document.getElementById('results-list');
    const resultsCount     = document.getElementById('results-count');
    const loader           = document.getElementById('results-loader');

    if (renderList) {
      resultsContainer.innerHTML = '';
      resultsCount.textContent = '';
      loader.classList.add('visible');
      lastCenter = center;
      lastRadius = radius;
    }

    const filters = getActiveFilters();
    const types   = getActiveTypes();
    const results = [];

    institutions.forEach(inst => {
      const lat = inst.location.latitude;
      const lng = inst.location.longitude;
      const distance = center ? getDistance(center.lat, center.lng, lat, lng) : null;

      const matchesFilter = !filters.length || filters.every(type => inst[type]);
      const inRadius      = !radius || (distance !== null && distance <= radius);
      const matchesType   = !types.length  || types.includes(inst.type);
      const shouldDisplay = (!center && !radius) || (matchesFilter && matchesType && inRadius);
      if (!shouldDisplay) return;

      const services = [];
      if (inst.psychological_help) services.push('psychological_help');
      if (inst.legal_help)         services.push('legal_help');
      if (inst.social_help)        services.push('social_help');
      if (inst.accommodation)      services.push('accommodation');

    // Wybierz wÅ‚aÅ›ciwy zestaw ikon w zaleÅ¼noÅ›ci od typu instytucji
    const iconsSet = inst.type === 'GOV' ? SMALL_ICONS.GOV : SMALL_ICONS.NGO;

    // Generowanie HTML dla ikon usÅ‚ug
    const iconsHtml = services
      .map(k => `<img class="help-icon" src="${iconsSet[k]}" alt="" style="width:18px;height:18px;vertical-align:middle;margin-right:6px;">`)
      .join("");

    // Generowanie badge typu instytucji
    const typeBadge =
      `<div class="type-badge ${inst.type === 'GOV' ? 'public' : 'ngo'}">` +
      `${inst.type === 'GOV' ? 'Publiczna' : 'PozarzÄ…dowa'}</div>`;

    // Wybierz ikony kontaktowe dla typu instytucji
    const contactIcons = CONTACT_ICONS[inst.type === 'GOV' ? 'GOV' : 'NGO'];

    const openingHours = normalizeTimeRange(inst.opening_hours);

    const popup =
      '<div class="popup-content ' + (inst.type === 'GOV' ? 'public' : 'ngo') + '">' +
        '<h3 class="popup-title">' + inst.name + '</h3>' +
        typeBadge +
        '<div class="popup-body">' +
          '<p>' + inst.address + '</p>' +
          '<p><img class="contact-icon" src="'+contactIcons.phone+'" alt="telefon"> ' + (inst.phone_number || 'brak') + '</p>' +
          '<p><img class="contact-icon" src="'+contactIcons.email+'" alt="email"> ' + (inst.email || 'brak') + '</p>' +
          '<p><img class="contact-icon" src="'+contactIcons.infoline+'" alt="infolinia"> ' + (inst.infoline || 'brak') + '</p>' +
          '<p><img class="contact-icon" src="'+contactIcons.hours+'" alt="Godziny"> ' + (openingHours || 'brak') + '</p>' +
        '</div>' +
        '<div class="popup-icons">' + iconsHtml + '</div>' +
      '</div>';

      // === NOWE: ikony jako SVG w kolorach brandu ===
      const pinColor =
        inst.name.includes('Czas Kobiet') ? PIN_COLORS.PRIORITY :
        (inst.type === 'GOV' ? PIN_COLORS.GOV : PIN_COLORS.NGO);

      const icon = L.divIcon({
        className: 'leaflet-div-icon svg-pin',
        html: pinSVG(pinColor),
        iconSize: [30, 44],
        iconAnchor: [15, 44],
        popupAnchor: [0, -38]
      });

      const marker = L.marker([lat, lng], { icon }).bindPopup(popup);
      markerCluster.addLayer(marker);

      results.push({ inst, distance, lat, lng, iconsHtml, typeBadge, marker });
    });

    if (renderList) {
      setTimeout(() => {
        loader.classList.remove('visible');

        if (!results.length) {
          resultsContainer.innerHTML = '';
          resultsCount.textContent = '';
          $('#sidebarResults')?.classList.remove('visible');
          showError('address-error', 'Brak wynikÃ³w dla podanych kryteriÃ³w.');
          return;
        }

        // Priorytet + odlegÅ‚oÅ›Ä‡
        const priorityNames = ['Fundacja Czas Kobiet','Feminoteka'];
        const isPriority = name => priorityNames.some(p => name.toLowerCase().includes(p.toLowerCase()));
        results.sort((a, b) => {
          const ap = isPriority(a.inst.name), bp = isPriority(b.inst.name);
          if (ap && !bp) return -1;
          if (!ap && bp) return 1;
          return (a.distance ?? Infinity) - (b.distance ?? Infinity);
        });

        const totalPages = Math.ceil(results.length / RESULTS_PER_PAGE);
        const startIndex = (currentPage - 1) * RESULTS_PER_PAGE;
        const endIndex   = startIndex + RESULTS_PER_PAGE;
        const pageResults = results.slice(startIndex, endIndex);

        resultsCount.innerHTML =
          '<div class="results-summary">' +
            (lastCenter && lastRadius
              ? ('Znaleziono ' + results.length + ' miejsc oferujÄ…cych wybrane formy pomocy w promieniu ' + lastRadius + ' km')
              : ('Znaleziono ' + results.length + ' miejsc oferujÄ…cych wybrane formy pomocy')) +
          '</div>';

        resultsContainer.innerHTML = '';
        pageResults.forEach(({ inst, distance, lat, lng, iconsHtml, typeBadge, marker }) => {
          const div = document.createElement('div');
          const contactIcons = CONTACT_ICONS[inst.type === 'GOV' ? 'GOV' : 'NGO'];
          const openingHours = normalizeTimeRange(inst.opening_hours);
          div.className = 'result-card ' + (inst.type === 'GOV' ? 'gov-card' : 'ngo-card');
          div.innerHTML =
          '<div class="result-header">' +
            '<div class="type-badge ' + (inst.type === 'GOV' ? 'public' : 'ngo') + '">' +
              (inst.type === 'GOV' ? 'Publiczna' : 'PozarzÄ…dowa') +
            '</div>' +
            '<div class="result-title">' + inst.name + '</div>' +
          '</div>' +

          '<div class="distance-info"> ' + (distance !== null ? (distance.toFixed(1) + ' km') : '') + '</div>' +

          '<div class="result-body collapsed">' +
            '<div class="result-content">' +
              '<p>' + inst.address + '</p>' +
              '<p><img class="contact-icon" src="' + contactIcons.phone + '" alt="telefon"> ' + (inst.phone_number || 'brak') + '</p>' +
              '<p><img class="contact-icon" src="' + contactIcons.infoline + '" alt="infolinia"> ' + (inst.infoline || 'brak') + '</p>' +
              '<p><img class="contact-icon" src="' + contactIcons.email + '" alt="email"> ' + (inst.email || 'brak') + '</p>' +
              '<p><img class="contact-icon" src="'+contactIcons.hours+'" alt="Godziny"> ' + (openingHours || 'brak') + '</p>' +
              '<div class="help-icons">' + iconsHtml + '</div>' +
            '</div>' +
          '</div>' +

          '<div class="result-footer">' +
            '<button class="toggle-btn">PokaÅ¼ wiÄ™cej</button>' +
          '</div>';

          const btn  = div.querySelector('.toggle-btn');
          const body = div.querySelector('.result-body');
          let expanded = false;
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            expanded = !expanded;
            body.classList.toggle('expanded', expanded);
            btn.textContent = expanded ? 'PokaÅ¼ mniej' : 'PokaÅ¼ wiÄ™cej';
          });

          div.addEventListener('click', () => {
            map.flyTo([lat, lng], 16, { animate: true, duration: 0.6 });
            setTimeout(() => marker.openPopup(), 600);
          });

          resultsContainer.appendChild(div);
        });

        // Paginacja
        const pagination = document.createElement('div');
        pagination.className = 'pagination';

        function addBtn(txt, handler, cls){
          const b = document.createElement('button');
          b.textContent = txt; if (cls) b.className = cls;
          b.addEventListener('click', handler);
          pagination.appendChild(b);
        }

        if (currentPage > 1) addBtn('â†', () => renderPage(currentPage - 1), 'page-arrow');

        const maxVisible = 3;
        const startPage  = Math.max(1, currentPage - Math.floor(maxVisible/2));
        const endPage    = Math.min(totalPages, startPage + maxVisible - 1);

        if (startPage > 1) { addBtn('1', () => renderPage(1), 'page-num'); if (startPage > 2) pagination.append('â€¦'); }
        for (let i = startPage; i <= endPage; i++) {
          const b = document.createElement('button');
          b.className = 'page-num' + (i === currentPage ? ' active' : '');
          b.textContent = i;
          b.addEventListener('click', () => renderPage(i));
          pagination.appendChild(b);
        }
        if (endPage < totalPages) { if (endPage < totalPages - 1) pagination.append('â€¦'); addBtn(String(totalPages), () => renderPage(totalPages), 'page-num'); }

        if (currentPage < totalPages) addBtn('â†’', () => renderPage(currentPage + 1), 'page-arrow');

        resultsContainer.appendChild(pagination);
      }, 300);
    }
  }

  function renderPage(page) {
    currentPage = page;
    renderInstitutions(lastCenter, lastRadius, true);
  }

  // ===== START =====
  map.whenReady(() => { fitToPoland(); });
  window.addEventListener('resize', debounce(fitToPoland, 150));

  // Pierwszy render â€“ same markery, bez listy
  renderInstitutions(null, null, false);
});
</script>
{% endblock %}
